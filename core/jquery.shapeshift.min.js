(function(){(function(e,c,a){var b,f,d;d="shapeshift";f={selector:"*",enableDrag:true,enableCrossDrop:true,enableResize:true,enableTrash:false,align:"center",colWidth:null,columns:null,minColumns:1,autoHeight:true,maxHeight:null,minHeight:100,gutterX:10,gutterY:10,paddingX:10,paddingY:10,animated:true,animateOnInit:false,animationSpeed:225,animationThreshold:100,dragClone:false,deleteClone:true,dragRate:100,dragWhitelist:"*",crossDropWhitelist:"*",cutoffStart:null,cutoffEnd:null,handle:false,cloneClass:"ss-cloned-child",activeClass:"ss-active-child",draggedClass:"ss-dragged-child",placeholderClass:"ss-placeholder-child",originalContainerClass:"ss-original-container",currentContainerClass:"ss-current-container",previousContainerClass:"ss-previous-container"};b=(function(){function g(i,h){this.element=i;this.options=e.extend({},f,h);this.globals={};this.$container=e(this.element);if(this.errorCheck()){this.init()}}g.prototype.errorCheck=function(){var h,j,k,i;i=this.options;k=false;j="Shapeshift ERROR:";if(i.colWidth===null){h=this.$container.children(i.selector);if(h.length===0){k=true;console.error(j+" option colWidth must be specified if Shapeshift is initialized with no active children.")}}return !k};g.prototype.init=function(){this.createEvents();this.setGlobals();this.setIdentifier();this.setActiveChildren();this.enableFeatures();this.gridInit();this.render();return this.afterInit()};g.prototype.createEvents=function(){var i,h;h=this.options;i=this.$container;i.off("ss-arrange").on("ss-arrange",(function(j){return function(l,k){if(k==null){k=false}return j.render(false,k)}})(this));i.off("ss-rearrange").on("ss-rearrange",(function(j){return function(){return j.render(true)}})(this));i.off("ss-setTargetPosition").on("ss-setTargetPosition",(function(j){return function(){return j.setTargetPosition()}})(this));return i.off("ss-destroy").on("ss-destroy",(function(j){return function(){return j.destroy()}})(this))};g.prototype.setGlobals=function(){return this.globals.animated=this.options.animateOnInit};g.prototype.afterInit=function(){return this.globals.animated=this.options.animated};g.prototype.setIdentifier=function(){this.identifier="shapeshifted_container_"+Math.random().toString(36).substring(7);return this.$container.addClass(this.identifier)};g.prototype.enableFeatures=function(){if(this.options.enableResize){this.enableResize()}if(this.options.enableDrag||this.options.enableCrossDrop){return this.enableDragNDrop()}};g.prototype.setActiveChildren=function(){var v,r,j,m,q,o,n,s,w,h,t,p,u;w=this.options;v=this.$container.children(w.selector);r=w.activeClass;u=v.length;for(q=o=0,h=u;0<=h?o<h:o>h;q=0<=h?++o:--o){e(v[q]).addClass(r)}this.setParsedChildren();m=w.columns;p=[];for(q=n=0,t=this.parsedChildren.length;0<=t?n<t:n>t;q=0<=t?++n:--n){j=this.parsedChildren[q].colspan;s=w.minColumns;if(j>m&&j>s){w.minColumns=j;p.push(console.error("Shapeshift ERROR: There are child elements that have a larger colspan than the minimum columns set through options.\noptions.minColumns has been set to "+j))}else{p.push(void 0)}}return p};g.prototype.setParsedChildren=function(){var o,j,q,l,h,p,n,m;j=this.$container.find("."+this.options.activeClass).filter(":visible");m=j.length;p=[];for(l=h=0,n=m;0<=n?h<n:h>n;l=0<=n?++h:--h){o=e(j[l]);q={i:l,el:o,colspan:parseInt(o.attr("data-ss-colspan"))||1,height:o.outerHeight()};p.push(q)}return this.parsedChildren=p};g.prototype.gridInit=function(){var i,h,k,j,l;j=this.options.gutterX;if(!(this.options.colWidth>=1)){k=this.parsedChildren[0];h=k.el.outerWidth();i=k.colspan;l=(h-((i-1)*j))/i;return this.globals.col_width=l+j}else{return this.globals.col_width=this.options.colWidth+j}};g.prototype.render=function(i,h){if(i==null){i=false}this.setGridColumns();return this.arrange(i,h)};g.prototype.setGridColumns=function(){var p,o,j,l,i,n,h,m,q,k;l=this.globals;q=this.options;o=l.col_width;n=q.gutterX;k=q.paddingX;h=this.$container.innerWidth()-(k*2);m=q.minColumns;j=q.columns||Math.floor((h+n)/o);if(m&&m>j){j=m}l.columns=j;p=this.parsedChildren.length;if(j>p){j=p}l.child_offset=k;switch(q.align){case"center":i=(j*o)-n;return l.child_offset+=(h-i)/2;case"right":i=(j*o)-n;return l.child_offset+=h-i}};g.prototype.arrange=function(m,A){var B,w,z,h,s,o,t,r,n,y,j,x,v,D,p,C,u,q,l;if(m){this.setParsedChildren()}n=this.globals;p=this.options;w=this.$container;o=this.getPositions();C=this.parsedChildren;l=C.length;z=n.animated&&l<=p.animationThreshold;h=p.animationSpeed;r=p.draggedClass;for(y=x=0,q=l;0<=q?x<q:x>q;y=0<=q?++x:--x){B=C[y].el;s=o[y];j=B.hasClass(r);if(j){u=p.placeholderClass;B=B.siblings("."+u)}if(z&&!j){B.stop(true,false).animate(s,h,function(){})}else{B.css(s)}}if(A){if(z){setTimeout((function(){return w.trigger("ss-drop-complete")}),h)}else{w.trigger("ss-drop-complete")}}w.trigger("ss-arranged");if(p.autoHeight){t=n.container_height;v=p.maxHeight;D=p.minHeight;if(D&&t<D){t=D}else{if(v&&t>v){t=v}}return w.height(t)}};g.prototype.getPositions=function(v){var n,y,r,p,l,z,h,w,u,m,t,B,q,A,o,x,s,j;if(v==null){v=true}l=this.globals;m=this.options;h=m.gutterY;t=m.paddingY;p=m.draggedClass;B=this.parsedChildren;j=B.length;n=[];for(w=u=0,o=l.columns;0<=o?u<o:u>o;w=0<=o?++u:--u){n.push(t)}x=(function(i){return function(k){var E,C,H,G,F,D,J,I;E=k.col;C=k.colspan;F=(k.col*l.col_width)+l.child_offset;D=n[E];q[k.i]={left:F,top:D};n[E]+=k.height+h;if(C>=1){I=[];for(H=G=1,J=C;1<=J?G<J:G>J;H=1<=J?++G:--G){I.push(n[E+H]=n[E])}return I}}})(this);y=(function(i){return function(k){var P,E,D,O,K,G,F,C,H,N,L,J,I,M;L=n.length-k.colspan+1;N=n.slice(0).splice(0,L);P=void 0;for(H=G=0,J=L;0<=J?G<J:G>J;H=0<=J?++G:--G){E=i.lowestCol(N,H);D=k.colspan;O=n[E];K=true;for(M=F=1,I=D;1<=I?F<I:F>I;M=1<=I?++F:--F){C=n[E+M];if(O<C){K=false;break}}if(K){P=E;break}}return P}})(this);s=[];A=(function(i){return function(){var H,E,C,k,J,I,F,D,G,K;K=[];for(G=E=0,J=s.length;0<=J?E<J:E>J;G=0<=J?++E:--E){D=s[G];D.col=y(D);if(D.col>=0){x(D);K.push(G)}}F=[];for(k=C=I=K.length-1;C>=0;k=C+=-1){H=K[k];F.push(s.splice(H,1))}return F}})(this);q=[];(r=(function(i){return function(){var E,k,C,D;D=[];for(w=k=0,C=j;0<=C?k<C:k>C;w=0<=C?++k:--k){E=B[w];if(!(!v&&E.el.hasClass(p))){if(E.colspan>1){E.col=y(E)}else{E.col=i.lowestCol(n)}if(E.col===void 0){s.push(E)}else{x(E)}D.push(A())}else{D.push(void 0)}}return D}})(this))();if(m.autoHeight){z=n[this.highestCol(n)]-h;l.container_height=z+t}return q};g.prototype.enableDragNDrop=function(){var p,u,n,x,l,t,o,v,q,y,m,s,j,w,r,k,i,h;j=this.options;u=this.$container;l=j.activeClass;m=j.draggedClass;r=j.placeholderClass;w=j.originalContainerClass;o=j.currentContainerClass;k=j.previousContainerClass;v=j.deleteClone;y=j.dragRate;q=j.dragClone;t=j.cloneClass;x=n=p=h=i=null;s=false;if(j.enableDrag){u.children("."+l).filter(j.dragWhitelist).draggable({addClasses:false,containment:"document",handle:j.handle,zIndex:9999,start:function(B,A){var z;x=e(B.target);if(q){p=x.clone(true).insertBefore(x).addClass(t)}x.addClass(m);z=x.prop("tagName");n=e("<"+z+" class='"+r+"' style='height: "+(x.height())+"px; width: "+(x.width())+"'></"+z+">");x.parent().addClass(w).addClass(o);h=B.pageY-x.offset().top;return i=B.pageX-x.offset().left},drag:(function(z){return function(B,A){if(!s&&!(q&&v&&e("."+o)[0]===e("."+w)[0])){n.remove().appendTo("."+o);e("."+o).trigger("ss-setTargetPosition");s=true;c.setTimeout((function(){return s=false}),y)}A.position.left=B.pageX-x.parent().offset().left-i;return A.position.top=B.pageY-x.parent().offset().top-h}})(this),stop:function(){var z,B,A;B=e("."+w);z=e("."+o);A=e("."+k);x.removeClass(m);e("."+r).remove();if(q){if(v&&e("."+o)[0]===e("."+w)[0]){p.remove();e("."+o).trigger("ss-rearrange")}else{p.removeClass(t)}}if(B[0]===z[0]){z.trigger("ss-rearranged",x)}else{B.trigger("ss-removed",x);z.trigger("ss-added",x)}B.trigger("ss-arrange").removeClass(w);z.trigger("ss-arrange",true).removeClass(o);A.trigger("ss-arrange").removeClass(k);return x=n=null}})}if(j.enableCrossDrop){return u.droppable({accept:j.crossDropWhitelist,tolerance:"intersect",over:(function(z){return function(A){e("."+k).removeClass(k);e("."+o).removeClass(o).addClass(k);return e(A.target).addClass(o)}})(this),drop:(function(z){return function(E,B){var A,D,C;if(z.options.enableTrash){D=e("."+w);A=e("."+o);C=e("."+k);x=e(B.helper);A.trigger("ss-trashed",x);x.remove();D.trigger("ss-rearrange").removeClass(w);A.trigger("ss-rearrange").removeClass(o);return C.trigger("ss-arrange").removeClass(k)}}})(this)})}};g.prototype.setTargetPosition=function(){var F,D,j,u,i,B,v,n,q,A,m,E,y,C,o,p,x,t,s,r,w,z,h,l;m=this.options;if(!m.enableTrash){q=m.draggedClass;F=e("."+q);D=F.parent();E=this.parsedChildren;i=this.getPositions(false);z=i.length;t=F.offset().left-D.offset().left+(this.globals.col_width/2);s=F.offset().top-D.offset().top+(F.height()/2);r=9999999;w=0;if(z>1){v=m.cutoffStart+1||0;B=m.cutoffEnd||z;for(C=A=p=v,x=B;p<=x?A<x:A>x;C=p<=x?++A:--A){u=i[C];if(u){l=t-u.left;h=s-u.top;if(l>0&&h>0){n=Math.sqrt((h*h)+(l*l));if(n<r){r=n;w=C;if(C===z-1){if(l>E[C].height/2){w++}}}}}}if(w===E.length){j=E[w-1].el;F.insertAfter(j)}else{j=E[w].el;F.insertBefore(j)}}else{if(z===1){u=i[0];if(u.left<t){this.$container.append(F)}else{this.$container.prepend(F)}}else{this.$container.append(F)}}this.arrange(true);if(D[0]!==F.parent()[0]){o=m.previousContainerClass;return e("."+o).trigger("ss-rearrange")}}else{y=this.options.placeholderClass;return e("."+y).remove()}};g.prototype.enableResize=function(){var i,j,h;i=this.options.animationSpeed;h=false;j="resize."+this.identifier;return e(c).on(j,(function(k){return function(){if(!h){h=true;setTimeout((function(){return k.render()}),i/3);setTimeout((function(){return k.render()}),i/3);return setTimeout(function(){h=false;return k.render()},i/3)}}})(this))};g.prototype.lowestCol=function(j,i){var h;if(i==null){i=0}h=j.map(function(l,k){return[l,k]});h.sort(function(l,k){var m;m=l[0]-k[0];if(m===0){m=l[1]-k[1]}return m});return h[i][1]};g.prototype.highestCol=function(h){return e.inArray(Math.max.apply(c,h),h)};g.prototype.destroy=function(){var h,j,i;j=this.$container;j.off("ss-arrange");j.off("ss-rearrange");j.off("ss-setTargetPosition");j.off("ss-destroy");i=this.options.activeClass;h=j.find("."+i);if(this.options.enableDrag){h.draggable("destroy")}if(this.options.enableCrossDrop){j.droppable("destroy")}h.removeClass(i);return j.removeClass(this.identifier)};return g})();return e.fn[d]=function(g){return this.each(function(){var j,h,i;h=(i=e(this).attr("class").match(/shapeshifted_container_\w+/))!=null?i[0]:void 0;if(h){j="resize."+h;e(c).off(j);e(this).removeClass(h)}return e.data(this,"plugin_"+d,new b(this,g))})}})(jQuery,window,document)}).call(this);